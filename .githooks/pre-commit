#!/usr/bin/env bash
set -euo pipefail

bad_path_regexes=(
  '(^|/)node_modules/'
  '(^|/)__pycache__/'
  '\.pyc$'
  '\.log$'
  '(^|/)\.env($|\.)'
)

blocked_files=()
while IFS= read -r -d '' file; do
  [[ -z "${file}" ]] && continue

  for pattern in "${bad_path_regexes[@]}"; do
    if echo "${file}" | grep -Eq "${pattern}"; then
      blocked_files+=("${file}")
      break
    fi
  done

  case "${file}" in
    *.pem|*.key|*.p12|*.pfx)
      blocked_files+=("${file}")
      ;;
  esac
done < <(git diff --cached --name-only -z)

if ((${#blocked_files[@]} > 0)); then
  {
    echo "pre-commit: blocked risky/large files from being committed:"
    for f in "${blocked_files[@]}"; do
      echo "  - ${f}"
    done
    echo
    echo "Fix:"
    echo "  - remove from staging: git restore --staged <path>"
    echo "  - or add/update .gitignore, then: git rm -r --cached <path>"
  } >&2
  exit 1
fi
